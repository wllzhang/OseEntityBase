# 工作记录 (Work Record)

本文档记录了项目开发过程中的工作总结、待完成任务和版本更新日志。

> 📝 详细的项目说明请参考 [README.md](README.md)

---

## 📋 目录

- [工作总结](#工作总结)
- [待完成任务](#待完成任务todo)
- [更新日志](#更新日志)

---

## 工作总结

### 2025年11月5日 - 代码重构与目录整理

#### 目录结构优化
- **模块化重组**: 创建了`ui/`和`widgets/`目录，将相关功能文件分类整理
- **清理旧代码**: 删除了`osgEarth.pro`相关文件（mainwindow.cpp/h/ui），项目已合并到ScenePlan2
- **路径统一**: 更新了所有文件引用路径，确保编译正常

#### 数据存储架构改进
- **组件信息深层复制**: 修改了实体属性保存机制，组件信息现在保存完整的深层复制（包含componentId、name、type、configInfo、templateInfo等），不再依赖数据库
- **方案文件独立**: 方案文件（.plan.json）现在完全独立，包含所有必要的实体信息，可在无数据库环境下使用
- **文档分离**: 将工作总结和更新日志分离到WorkRecord.md，使README更专注于项目说明

### 2025年11月4日 - 基类重构与架构优化

#### 基类重构与公共实现提取
- **默认生命周期实现**: 在`GeoEntity`基类中添加了`initialize()`、`update()`、`cleanup()`的默认实现，统一管理实体的生命周期流程
- **生命周期回调机制**: 引入了`onInitialized()`、`onUpdated()`、`onBeforeCleanup()`、`onAfterCleanup()`四个回调方法，子类可通过重写回调来扩展特定逻辑
- **节点变换辅助方法**: 添加了`setupNodeTransform()`和`createPATNode()`辅助方法，统一处理地理坐标到世界坐标的转换和PAT节点的创建
- **子类代码简化**: 重构了`ImageEntity`和`WaypointEntity`，大幅减少了重复代码，使子类代码更专注于特定实现

#### 代码质量改进
- **编译错误修复**: 修复了子类重写保护方法的声明问题，确保代码符合C++标准
- **注释文档完善**: 为所有新增和重构的方法添加了详细的Doxygen注释，包括方法流程、使用场景、注意事项和使用示例
- **代码可维护性提升**: 公共逻辑集中到基类管理，后续优化和修复只需修改一处，降低了维护成本

#### 架构优化效果
- **消除代码重复**: 所有实体共享统一的生命周期管理逻辑，避免了多处实现不一致的问题
- **扩展更简单**: 新增实体类型只需实现`createNode()`和必要的回调方法，大大降低了开发成本
- **错误率降低**: 统一的初始化、更新、清理流程减少了遗漏和错误

### 2025年10月31日 - 坐标精度修复与代码重构

#### 坐标转换精度修复
- **Y轴翻转问题修复**: 解决了Qt窗口坐标系（Y=0在顶部）与OSG视口坐标系（Y=0在底部）不匹配的问题，修复了拖拽时点击上方实体出现在下方的bug
- **坐标系统转换**: 添加了MainWindow坐标到GLWidget本地坐标的转换，确保`dropEvent`中的坐标正确传递给OSG

#### 代码重构与优化
- **提取工具类**: 创建了`GeoUtils`工具类，统一处理屏幕坐标到地理坐标的转换逻辑
- **消除重复代码**: 将`MainWindow`、`GeoEntityManager`、`MapStateManager`中的重复坐标转换代码提取为公共函数
- **提升可维护性**: 坐标转换逻辑集中管理，后续优化和修复只需修改一处

#### Doxygen文档完善
- **API文档**: 为所有核心头文件添加了完整的Doxygen注释（`GeoEntity`、`ImageEntity`、`WaypointEntity`、`GeoEntityManager`、`MapStateManager`）
- **模块分组**: 创建了`geo_entities`和`managers`两个Doxygen分组，便于文档导航
- **主页面重写**: 重写了`docs/mainpage.md`，提供更清晰的架构概览和快速开始指南

### 2025年10月30日 - 路线规划与交互优化

- **路线规划功能**: 基于点标绘的控制点生成线性连线，并可绑定到实体
- **点标绘基础**: 支持在地图上绘制点与顺序标签；点按组管理
- **选中阈值自适应**: 依据当前地图 `range` 动态调整选中阈值，提升选择稳定性
- **视角交互修复**: 解决选中实体后滚轮缩放不可用的问题，恢复正常交互
- **删除稳定性**: 采用"标记+QTimer延时删除"策略，修复删除实体导致崩溃的问题
- **代码与架构**: 鼠标交互统一收敛到 `GeoEntityManager`；部分阈值与状态从 `MapStateManager` 获取
- **后续计划**: 与慧慧页面集成、航向角设置问题排查、拖拽定位精度优化、规划结果导出为 AFSIM、推进"信息层抽象"

---

## 待完成任务TODO

### 🔴 高优先级

1. **坐标精度优化** - 拖拽添加时坐标不精确，主要是坐标算法不精确，导致很多功能都不行
2. **航向角设置修复** - 航向角设置功能存在问题，需要排查和修复

### 🟡 中优先级

3. **路线平滑处理** - 路线生成无法生成平滑的曲线，需要改进算法
4. **实体信息管理** - 增加所有的实体信息展示管理页面

### 🟢 低优先级

5. **格式转换** - 规划结果转化为AFSIM文档
6. **信息层抽象** - 长期目标
   - 地图状态信息抽象
   - 实体状态信息抽象
   - 服务接口设计

---

## 更新日志

### v2.2.0 (2025-11-04)
**基类重构与架构优化**

#### 🏗️ 架构优化
- **默认生命周期实现** - 在`GeoEntity`基类中添加了`initialize()`、`update()`、`cleanup()`的默认实现，统一管理实体的生命周期流程
- **生命周期回调机制** - 引入了四个回调方法，支持子类扩展特定逻辑：
  - `onInitialized()` - 初始化完成回调
  - `onUpdated()` - 更新完成回调（用于更新标签等）
  - `onBeforeCleanup()` - 清理前回调（用于移除子节点）
  - `onAfterCleanup()` - 清理后回调
- **节点变换辅助方法** - 添加了辅助方法，统一处理坐标转换和节点创建：
  - `setupNodeTransform()` - 设置节点的位置和旋转变换
  - `createPATNode()` - 创建并初始化PositionAttitudeTransform节点

#### 🔧 代码质量改进
- **子类代码简化** - 重构了`ImageEntity`和`WaypointEntity`，大幅减少了重复代码，使子类代码更专注于特定实现
- **注释文档完善** - 为所有新增和重构的方法添加了详细的Doxygen注释，包括方法流程、使用场景、注意事项和使用示例
- **编译错误修复** - 修复了子类重写保护方法的声明问题，确保代码符合C++标准

#### 📈 优化效果
- **消除代码重复** - 所有实体共享统一的生命周期管理逻辑，避免了多处实现不一致的问题
- **扩展更简单** - 新增实体类型只需实现`createNode()`和必要的回调方法，大大降低了开发成本
- **错误率降低** - 统一的初始化、更新、清理流程减少了遗漏和错误

### v2.1.0 (2025-10-31)
**坐标精度修复与代码重构**

#### 🐛 Bug修复
- **Y轴翻转问题修复** - 解决了Qt窗口坐标系（Y=0在顶部）与OSG视口坐标系（Y=0在底部）不匹配的问题，修复了拖拽时点击上方实体出现在下方的bug
- **坐标系统转换** - 添加了MainWindow坐标到GLWidget本地坐标的转换，确保`dropEvent`中的坐标正确传递给OSG

#### 🔧 代码重构
- **工具类提取** - 创建了`GeoUtils`工具类，统一处理：
  - 屏幕坐标到地理坐标的转换逻辑
  - 地理坐标到世界坐标的转换逻辑
  - JSON配置文件加载
  - 距离计算（2D、3D、地理距离）
  - EarthManipulator获取
- **消除重复代码** - 将`MainWindow`、`GeoEntityManager`、`MapStateManager`中的重复代码提取为公共函数
- **可维护性提升** - 坐标转换逻辑集中管理，后续优化和修复只需修改一处

#### 📚 文档完善
- **Doxygen API文档** - 为所有核心头文件添加了完整的Doxygen注释：
  - `GeoEntity` - 通用地理实体基类
  - `ImageEntity` - 图片实体实现
  - `WaypointEntity` - 航点实体实现
  - `GeoEntityManager` - 实体管理器
  - `MapStateManager` - 地图状态管理器
- **模块分组** - 创建了`geo_entities`和`managers`两个Doxygen分组，便于文档导航
- **主页面优化** - 重写了`docs/mainpage.md`，提供更清晰的架构概览、快速开始指南和使用示例

### v2.0.0 (2025-10-30)
**路线规划与交互优化**

#### 🎯 核心功能
- **路线规划功能** - 基于点标绘的控制点生成线性连线，并可绑定到实体
- **点标绘基础** - 支持在地图上绘制点与顺序标签（1,2,3,4），点按组管理
- **WaypointEntity实现** - 基于GeoEntity的航点实体类，支持CircleNode和PlaceNode显示

#### 🔧 技术改进
- **选中阈值自适应** - 依据当前地图`range`动态调整选中阈值，提升选择稳定性
- **视角交互修复** - 解决选中实体后滚轮缩放不可用的问题，恢复正常交互
- **删除稳定性优化** - 采用"标记+QTimer延时删除"策略，修复删除实体导致崩溃的问题
- **事件处理优化** - 鼠标交互统一收敛到`GeoEntityManager`，阈值与状态从`MapStateManager`获取

#### 📐 功能完善
- **线性/贝塞尔路线生成** - 支持线性模型和贝塞尔曲线模型生成轨迹连线
- **轨迹绑定机制** - 将生成的路由轨迹绑定到指定实体，支持编辑和管理

### v1.3.0 (2025-10-24)
**实体交互功能完善**

#### 🎯 核心功能
- **实体选择系统** - 点击实体进行选择，支持高亮显示
- **右键上下文菜单** - 完整的实体操作菜单系统
- **实体属性设置** - 航向角和高度设置功能

#### 🔧 技术改进
- **事件处理架构重构** - GeoEntityManager统一处理鼠标事件
- **信号槽机制优化** - 使用Qt信号槽进行组件间通信
- **多态支持完善** - 虚函数实现实体选择的高亮功能
- **职责分离设计** - MainWindow专注UI，GeoEntityManager专注实体交互

#### 🎨 交互功能
- **实体高亮显示** - 选中实体显示红色边框
- **航向角设置** - 通过对话框修改实体朝向
- **高度设置** - 通过对话框修改实体高度
- **实体删除** - 确认删除选中的实体
- **属性查看** - 显示实体的详细信息

### v1.2.0 (2025-10-24)
**拖拽功能优化**

#### 🔧 技术改进
- **精确坐标定位** - 拖拽时使用鼠标实际地理坐标
- **相机视角跳转** - 拖拽后自动调整视角到实体位置
- **坐标转换优化** - 屏幕坐标到地理坐标的准确转换

### v1.1.0 (2025-10-24)
**2D/3D视图切换功能**

#### 🎯 新功能
- **2D/3D切换按钮** - 动态切换地图显示模式
- **自定义视角配置** - 2D和3D模式使用不同视角参数
- **视角自动跳转** - 切换模式时自动调整到预设视角

#### 📐 视角配置
- **2D视角参数** - Pitch: -90°, Heading: -0.916737°, Range: 540978
- **3D视角参数** - Pitch: -76.466°, Heading: 0°, Range: 12725200

### v1.0.0 (2025-10-24)
**初始版本 - 基础功能实现**

#### 🎯 核心功能
- **3D地图显示** - 基于osgEarth的3D地球渲染
- **实体管理系统** - GeoEntity基类和ImageEntity实现
- **拖拽功能** - 从列表拖拽实体到地图
- **MapStateManager支持** - 地图状态管理

#### 🔧 技术实现
- **Qt-OSG集成** - GraphicsWindowQt组件
- **实体配置** - JSON配置文件支持
- **模块化设计** - geo模块独立管理

---

## 📊 统计信息

- **总版本数**: 8个主要版本
- **首次提交**: 2025-10-24
- **最新更新**: 2025-11-05
- **代码文件**: 约30+个源文件
- **文档文件**: README.md, WorkRecord.md, docs/mainpage.md
